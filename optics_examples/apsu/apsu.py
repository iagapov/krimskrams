from ocelot import *
import sys


D11 = Drift(l=2.908094200746698)
D12 = Drift(l=0.4050838254873592)
D13 = Drift(l=0.05014404837641349)

S02A_P0 = Marker() # monitor
S02B_P0 = Marker() # monitor
S02A_Q1 = Quadrupole(l=0.25,k1=3.311988223666687)
S02B_Q1 = Quadrupole(l=0.25,k1=3.311988223666687)
S02A_Q2 = Quadrupole(l=0.225,k1=-2.806503327862326)
S02B_Q2 = Quadrupole(l=0.225,k1=-2.806503327862326)
S02A_Q3 = Quadrupole(l=0.225,k1=-2.289738957179781)
S02B_Q3 = Quadrupole(l=0.225,k1=-2.289738957179781)
S02A_Q4 = SBend(l=0.244,angle=-0.001706915788384977,k1=3.44665225417214,e1=-0.0008534578941924886,e2=-0.0008534578941924886)
S02B_Q4 = SBend(l=0.244,angle=-0.001706915788384977,k1=3.44665225417214,e1=-0.0008534578941924886,e2=-0.0008534578941924886)

S02A_Q5 = SBend(l=0.15,angle=-0.001157494675584733,k1=1.578426896828277,e1=-0.0005787473377923666,e2=-0.0005787473377923666)
S02B_Q5 = SBend(l=0.15,angle=-0.001157494675584733,k1=1.578426896828277,e1=-0.0005787473377923666,e2=-0.0005787473377923666)


S02A_Q6 = Quadrupole(l=0.225,k1=-2.463268052877983)
S02B_Q6 = Quadrupole(l=0.225,k1=-2.463268052877983)

S02A_Q7 = Quadrupole(l=0.424,k1=3.720956199980586)
S02B_Q7 = Quadrupole(l=0.424,k1=3.720956199980586)




IDAP = Marker() # aperture
AP = Marker() # aperture
PAAP1 = Marker() # aperture
S02A_P1 = Marker() # monitor


S02A_F8P1 = Marker(); # originally 0-length thing with skew quad and kicker


S02G1 =(D11,S02A_P0,IDAP,AP,S02A_Q1,PAAP1,S02A_P1,D12,S02A_F8P1,S02A_Q2,D13)


PABP1 = Marker()
S02B_F8P1 = Marker()
S02B_P1 = Marker()

S02G9R =(D11,S02B_P0,IDAP,AP,S02B_Q1,S02B_P1,PABP1,D12,S02B_F8P1,S02B_Q2,D13)
S02G9 =S02G9R[::-1]



MEA = Marker()
MEAQ = Marker()


S02A_M1_1 = SBend(l=0.1918442167511646,angle=0.006231803373120651,e1=0.01428579517461679,e2=-0.008053991801496133)
S02A_M1_2 = SBend(l=0.2329808449846517,angle=0.004652921987100712,e1=0.008053991801496133,e2=-0.003401069814395421)
S02A_M1_3 = SBend(l=0.4931459233303774,angle=0.00665360325628307,e1=0.003401069814395421,e2=0.003252533441887649)
S02A_M1_4 = SBend(l=0.6710407783161596,angle=0.006543582722312399,e1=-0.003252533441887649,e2=0.009796116164200048)
S02A_M1_5 = SBend(l=0.6358861013789447,angle=0.004489679010416737,e1=-0.009796116164200048,e2=0.01428579517461679)

S02B_M1_1 = SBend(l=0.1918442167511646,angle=0.006231803373120651,e1=0.01428579517461679,e2=-0.008053991801496133)
S02B_M1_2 = SBend(l=0.2329808449846517,angle=0.004652921987100712,e1=0.008053991801496133,e2=-0.003401069814395421)
S02B_M1_3 = SBend(l=0.4931459233303774,angle=0.00665360325628307,e1=0.003401069814395421,e2=0.003252533441887649)
S02B_M1_4 = SBend(l=0.6710407783161596,angle=0.006543582722312399,e1=-0.003252533441887649,e2=0.009796116164200048)
S02B_M1_5 = SBend(l=0.6358861013789447,angle=0.004489679010416737,e1=-0.009796116164200048,e2=0.01428579517461679)

S02A_M2_1 = SBend(l=0.2918558259213946,angle=0.002351573364742646,e1=0.01164721598470094,e2=-0.009295642619958291)
S02A_M2_2 = SBend(l=0.3585886481950252,angle=0.003259700715380325,e1=0.009295642619958291,e2=-0.006035941904577966)
S02A_M2_3 = SBend(l=0.486869605945606,angle=0.005176222536330231,e1=0.006035941904577966,e2=-0.0008597193682477354)
S02A_M2_4 = SBend(l=0.3076438971768664,angle=0.003868138226183781,e1=0.0008597193682477354,e2=0.003008418857936046)
S02A_M2_5 = SBend(l=0.5397184855320805,angle=0.008638797126764892,e1=-0.003008418857936046,e2=0.01164721598470094)

S02B_M2_1 = SBend(l=0.2918558259213946,angle=0.002351573364742646,e1=0.01164721598470094,e2=-0.009295642619958291)
S02B_M2_2 = SBend(l=0.3585886481950252,angle=0.003259700715380325,e1=0.009295642619958291,e2=-0.006035941904577966)
S02B_M2_3 = SBend(l=0.486869605945606,angle=0.005176222536330231,e1=0.006035941904577966,e2=-0.0008597193682477354)
S02B_M2_4 = SBend(l=0.3076438971768664,angle=0.003868138226183781,e1=0.0008597193682477354,e2=0.003008418857936046)
S02B_M2_5 = SBend(l=0.5397184855320805,angle=0.008638797126764892,e1=-0.003008418857936046,e2=0.01164721598470094)


S02A_M3_1 = SBend(l=0.41,angle=0.0125396570573382,k1=-2.102081026538629,e1=0.0125396570573382)
S02A_M3_2 = SBend(l=0.41,angle=0.0125396570573382,k1=-2.102081026538629,e2=0.0125396570573382)

S02B_M3_1 = SBend(l=0.41,angle=0.0125396570573382,k1=-2.102081026538629,e1=0.0125396570573382)
S02B_M3_2 = SBend(l=0.41,angle=0.0125396570573382,k1=-2.102081026538629,e2=0.0125396570573382)



S02A_M1 = (S02A_M1_1,S02A_M1_2,S02A_M1_3,S02A_M1_4,S02A_M1_5)
S02B_M1 = (S02B_M1_5,S02B_M1_4,S02B_M1_3,S02B_M1_2,S02B_M1_1)

S02A_M2 = (S02A_M2_1,S02A_M2_2,S02A_M2_3,S02A_M2_4,S02A_M2_5)
S02B_M2 = (S02B_M2_5,S02B_M2_4,S02B_M2_3,S02B_M2_2,S02B_M2_1)

S02A_M3 = (S02A_M3_1,S02A_M3_2)
S02B_M3 = (S02B_M3_1,S02B_M3_2)




S02G2 =(MEA,MEAQ,S02A_M1,MEA)
S02G8R =(MEA,MEAQ,S02B_M1,MEA)

S02G8 = S02G8R[::-1]


D21A = Drift(l=0.1261130139900061)
D21B = Drift(l=0.1186762596753099)
D24 = Drift(l=0.274356565603497)
D25 = Drift(l=0.1100000007807403)
D26 = Drift(l=0.1406971943591799)
D27 = Drift(l=0.3249533473724555)
D28 = Drift(l=0.1481070804106769)
D29 = Drift(l=0.05001490735387127)

D51= Drift(l=0.05000239994950361)
D52= Drift(l=0.2157226954362602)
D53= Drift(l=0.115030162986725)
D54= Drift(l=0.2706450913189496)


D55A= Drift(l=0.06032254565947483)
D55B = Drift(l=0.06032254565947483)
WIGH = Drift(l=0.075)
WIGM = Marker()
WIGBL =(D55A,WIGH,WIGM,WIGH,D55B)



S02A_P2 = Marker()
S02B_P2 = Marker()

S02A_S1L =  Sextupole(l=0.1147718431634487,k2=-145.4210458921619)
S02B_S1L =  Sextupole(l=0.1147718431634487,k2=-136.6968898921619)

S02A_S2L =  Sextupole(l=0.1298984164119772,k2=132.8776653978636)
S02B_S2L =  Sextupole(l=0.1298984164119772,k2=140.0338894978636)

S02A_S3L =  Sextupole(l=0.1147718431634487,k2=-115.2625136921619)
S02B_S3L =  Sextupole(l=0.1147718431634487,k2=-126.2773908921619)


S02A_P3 = Marker()
S02A_P4 = Marker()
S02A_F8P2 = Marker()
S02B_P3 = Marker()
S02B_P4 = Marker()
S02B_F8P2 = Marker()


PAAP4 = Marker()
PAAP3 = Marker()
PABP2 = Marker()
PABP3 = Marker()
PABP4 = Marker()

dins = Drift(l=0.41)

S02G3 = (D21A,S02A_Q3, D21B,S02A_P2,S02A_S1L,D24,S02A_Q4,PAAP3,S02A_P3,D25,S02A_S2L, D26,
        S02A_Q5, D27,S02A_F8P2,S02A_S3L,PAAP4, S02A_P4,D28, dins  ,S02A_Q6,D29)




S02G7R = (D21A,S02B_Q3,D21B,S02B_P2,PABP2,S02B_S1L,D24,S02B_Q4,
    S02B_P3,PABP3,D25,S02B_S2L,D26,S02B_Q5,D27,S02B_F8P2,S02B_S3L,
    S02B_P4,PABP4,D28,dins, S02B_Q6,D29)


S02G7 = S02G7R[::-1]

S02G4 = (MEA,S02A_M2,MEA)


S02G6R = (MEA,S02B_M2,MEA)
S02G6 = S02G6R[::-1]

S02A_Q8 = SBend(l=0.646,angle=-0.005358586672065405,k1=3.681034532090332,e1=-0.002679293336032703,e2=-0.002679293336032703)
S02B_Q8 = SBend(l=0.646,angle=-0.005358586672065405,k1=3.681034532090332,e1=-0.002679293336032703,e2=-0.002679293336032703)


S02A_M4_1 = SBend(l=0.35, angle=0.009817477042468103,k1=-2.190470816373653,e1=0.009817477042468103)
S02A_M4_2 = SBend(l=0.35, angle=0.009817477042468103,k1=-2.190470816373653,e2=0.009817477042468103)

S02A_M4 = (S02A_M4_1, S02A_M4_2)



S02G5 = (D51,S02A_Q7,D52,S02A_M3,D53,S02A_Q8,
    D54,S02A_M4,WIGBL,S02B_Q8,D53,S02B_M3,D52, S02B_Q7,D51)


S02 =(S02G1,S02G2,S02G3,S02G4,S02G5,S02G6,S02G7,S02G8,S02G9)

#S02 =(S02G1,S02G2,S02G3,S02G4)




lat = MagneticLattice(S02)

a_scale = 1.0
l_scale = 1.0

for e in lat.sequence:
    #if e.__class__ in (SBend, Bend): e.angle /= a_scale
    if e.__class__ in (Quadrupole,SBend, Bend): e.k1 *= (l_scale)**2
    #if e.__class__ in (Sextupole,): e.k2 *= (l_scale)**3
    e.l /= l_scale

lat.update_transfer_maps()

beam = Beam()
beam.E = 6.0


tws0 = Twiss(beam)

tws0.beta_x = 4.93
tws0.beta_y = 1.89
tws0.dx = 5.7e-4

#tws = twiss(lat, tws0,  nPoints=100)

tws = twiss(lat, nPoints=100)


eb = EbeamParams(lat, beam, nsuperperiod=1)
print(eb.emittance * 1.e12)
print(eb)

ang = 0.0
for e in lat.sequence:
    #print e, e.__class__
    if e.__class__ in (SBend, Bend): ang += e.angle
    if e.__class__ in (SBend, Bend, Quadrupole):
        print 'gradient:', (e.k1) * 6.0 / 0.299, 'T/m'

print 'total angle:', ang / pi * 180


from ocelot.gui.accelerator import *
from pylab import *
plot_opt_func(lat, tws, legend = False)
plt.show()
